name: Verify secrets & smoke-test API üîê

on:
  workflow_dispatch:
  push:
    branches: [ "main" ]

permissions:
  contents: read

jobs:
  validate-and-smoke:
    name: Validate secrets + smoke test
    runs-on: ubuntu-latest
    timeout-minutes: 10
    env:
      API_URL: https://generativelanguage.googleapis.com/v1/models/text-bison-001:generate
      SMOKE_PROMPT: '{"prompt":{"text":"Hello"},"maxOutputTokens":5}'
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Ensure no committed API keys (fast scan)
        run: |
          echo "Scanning for literal Google API keys in repo (excluded: venv/.git)..."
          set -o pipefail
          matches=$(grep -RI --exclude-dir=venv --exclude-dir=.git --exclude='*.pyc' --line-number 'AIzaSy[A-Za-z0-9_-]\{30,\}' . || true)
          if [ -n "$matches" ]; then
            echo "ERROR: Found literal API key(s) in the repository:"
            echo "$matches"
            exit 2
          fi
          echo "No literal API keys found."

      - name: Verify `GOOGLE_API_KEY` exists (safe)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
        run: |
          if [ -z "${GOOGLE_API_KEY:-}" ]; then
            echo "ERROR: secrets.GOOGLE_API_KEY is missing ‚Äî add it to the repo secrets"
            exit 3
          fi
          echo "GOOGLE_API_KEY last6: ****${GOOGLE_API_KEY: -6}"

      - name: Smoke test Generative API (shows API response / error JSON)
        env:
          GOOGLE_API_KEY: ${{ secrets.GOOGLE_API_KEY }}
          API_URL: ${{ env.API_URL }}
          SMOKE_PROMPT: ${{ env.SMOKE_PROMPT }}
        run: |
          set -euo pipefail
          echo "Running smoke test against Generative API..."
          http_status=$(curl -s -o /tmp/resp.json -w "%{http_code}" \
            -X POST "${API_URL}?key=${GOOGLE_API_KEY}" \
            -H 'Content-Type: application/json; charset=utf-8' \
            -d "${SMOKE_PROMPT}" || true)
          echo "HTTP status: $http_status"
          cat /tmp/resp.json | jq . | sed -n '1,200p'
          if [ "$http_status" -ne 200 ]; then
            echo "::error::Smoke test failed (status $http_status). See response above."
            exit 4
          fi
          echo "Smoke test succeeded."

      - name: Add short workflow summary
        if: ${{ always() }}
        run: |
          echo "Secret check completed. If the smoke test failed check: - secret value - Google Cloud key status - project-level flagging" 
